@{
    ViewData["Title"] = "Devices Page";
}

<div id="tabs">
    <ul>
        <li><a href="#tabs-1">Last Posted Data</a></li>
        <li><a href="#tabs-2">Historical Data</a></li>
        <li><a href="#tabs-3">Analysis Report</a></li>
    </ul>
    <div id="tabs-1">
        <div id="main">
            <div id="result"></div>
            <div class="tile">
                <h3>Count of Device Events Processed:</h3>
                <div id="queueLength">Loading..</div>
            </div>
            <div class="tile">
                <h3>Devices</h3>
                <ul id="deviceList"></ul>
            </div>
        </div>
    </div>
    <div id="tabs-2">
        <div class="margin-top-10">
            <div class="float-left">
                <form class="display-inline">
                    <div class="div-left">
                        <span><b>Starting Timestamp </b></span>
                    </div>
                    <div class="div-left">
                        <input id="txtTimestamp" width="200" />
                    </div>
                    <div class="div-left">
                        &nbsp;&nbsp;&nbsp;
                        <button id="btnSearch" type="button" class="gj-button-md">Search</button>
                        <label for="batchIndex"> Index </label>
                        <input id="batchIndex" type="text" size="5" placeholder="0" />
                        &nbsp;&nbsp;&nbsp;
                        <a id="batchFirst" href="#" class="previous">&laquo; First</a>
                        <a id="batchPrevious" href="#" class="previous round">&#8249;</a>
                        <a id="batchNext" href="#" class="next round">&#8250;</a>
                        <a id="batchLast" href="#" class="next">Last &raquo;</a>
                        &nbsp;&nbsp;&nbsp;
                        <label for="batchSizeSelect">Batch Size </label>
                    </div>
                    <div class="div-left">
                        <select id="batchSizeSelect" width="50">
                            <option value="200">200</option>
                            <option value="100">100</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    <div class="div-left">
                        &nbsp;&nbsp;&nbsp;
                        <span id="batchTotalCountLabel">Total Row Count</span>
                        &nbsp;
                        <span id="batchTotalCount">Loading...</span>
                    </div>
                </form>
            </div>
        </div>
        <div class="clear-both"></div>
        <div class="margin-top-10">
            <table id="grid"></table>
        </div>
    </div>
    <div id="tabs-3">
        <iframe width="1280" height="750" src="https://app.powerbi.com/view?r=eyJrIjoiYjEzNzY4MTMtNjU0Mi00OGJiLWIyZjgtYjU4ZWYwMjVhZGZlIiwidCI6IjNkMmQyYjZmLTA2MWEtNDhiNi1iNGIzLTkzMTJkNjg3ZTNhMSIsImMiOjN9" frameborder="0" allowFullScreen="true"></iframe>
    </div>
</div>

@section scripts
    {
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/npm/gijgo@1.9.6/css/gijgo.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/gijgo@1.9.6/js/gijgo.min.js" type="text/javascript"></script>

    <script>
    $('#batchSizeSelect').dropdown();

    var path = window.location.pathname.replace(/\/+$/, "");
    var searchStartTimestamp = "01/01/2018 00:00";
    var batchSize = 200;
    var totalCount = 0;
    var batchIndex = 1;
    var maxBatchIndex = 0;

    $( "#batchFirst" ).click(function() {
        $('#batchIndex').val(1);
        batchIndex = $('#batchIndex').val();
    });

    $( "#batchLast" ).click(function() {
          $('#batchIndex').val(maxBatchIndex);
          batchIndex = $('#batchIndex').val();
    });

    $( "#batchPrevious" ).click(function() {
        if( $('#batchIndex').val() > 1 )
        {
            $('#batchIndex').val(parseInt($('#batchIndex').val()) - 1 );
            batchIndex = $('#batchIndex').val();
        }
    });

    $( "#batchNext" ).click(function() {
        if( $('#batchIndex').val() < maxBatchIndex )
        {
            $('#batchIndex').val( parseInt($('#batchIndex').val()) + 1);
            batchIndex = $('#batchIndex').val();
        }
    });

    $( "#batchSizeSelect" ).change(function() {
        if( $('#batchIndex').val() != batchSize )
        {
            batchSize = $('#batchIndex').val();

            maxBatchIndex = Math.floor(totalCount / batchSize) + 1;

            if( $('#batchIndex').val() > maxBatchIndex )
            {
                $('#batchIndex').val( maxBatchIndex );
                batchIndex = $('#batchIndex').val();
            }
        }
    });


    $(function () {
        $("#tabs").tabs();
    });

    var grid = "empty";
    var gridData = {'deviceMessages':{"batchIndex": 1,"batchSize": 200,"searchStartTimestamp": "2018-05-10T03:15:39.9083997+00:00","totalCount":1,"rows":[{"timestamp": "empty","deviceId": "empty","measurementType": "empty","sensorIndex": 0,"temperature": 0,"batteryLevel":0,"dataPointsCount":0}]}};
    var reportPathForReport01ByKey = '/' + '@ViewData["TargetSite"]' + '/run/report/VibrationReport01/byKey/';

    $(document).ready(function () {
       refreshGridata();
       populateGridData();
       updateRelatedGridata();
    });

    $('#btnSearch').on('click', function () {
         refreshGridata();
         grid.destroy();
         populateGridData();
         updateRelatedGridata();
         if( $('#txtTimestamp').val() != searchStartTimestamp )
            $('#txtTimestamp').val(searchStartTimestamp);
    });

    function Report02(evnt) {
        //alert("Url for report =[" + reportPathForReport01ByKey + evnt.data.record.timestamp + "]");

        popitup(reportPathForReport01ByKey + evnt.data.record.timestamp,reportPathForReport01ByKey + evnt.data.record.timestamp);
        return false;
    }


    refreshGridata = function () {
        //alert( 'Grid URL=[' + path + '/history/batchIndex/' + batchIndex + '/batchSize/' + batchSize + ']' );
        $.ajax({
            url: path + '/history/batchIndex/' + batchIndex + '/batchSize/' + batchSize,
            async: false,
            method: 'GET',
            contentType: 'application/json',
            dataType: 'json',
            success: function (result) {
                gridData = result;
            },
            error: function (error) {
                alert( "Error reading Grid Data - message=" +  error.responseText);
            }
        })
        // alert(JSON.stringify(gridData));
    }

    populateGridData = function() {
      grid = $('#grid').grid({
         dataSource: gridData.rows,
         columns: [
             { field: 'timestamp', title: 'Message Timestamp', width:300},
             { field: 'deviceId', title: 'Device Id', sortable: true },
             { field: 'measurementType', title: 'Measurement Type', sortable: true },
             { field: 'temperature', title: 'Temperature', sortable: true },
             { field: 'sensorIndex', title: 'Sensor Index', sortable: true },
             { field: 'batteryLevel', title : 'Battery Level', sortable: true },
             { field: 'dataPointsCount', title: 'Data Points Count' },
             { width: 64, tmpl: '<span class="material-icons gj-cursor-pointer">report</span>', align: 'center', events: { 'click': Report02 } }
         ],
         pager: { limit: 10 }
      });
    }

    updateRelatedGridata = function() {
         $('#batchTotalCount').html(gridData.totalCount);
         totalCount = gridData.totalCount;
         batchSize = gridData.batchSize;
         maxBatchIndex = Math.floor(totalCount / batchSize) + 1;

         var searchStartDate = new Date(gridData.searchStartTimestamp);
         searchStartTimestamp = searchStartDate.getUTCFullYear() + '/' + searchStartDate.getUTCMonth() + '/' + searchStartDate.getUTCDate() + ' ';
         if( searchStartDate.getHours() < 10 )
             searchStartTimestamp = searchStartTimestamp + ' 0' + searchStartDate.getUTCHours() + ':';
         else
             searchStartTimestamp = searchStartTimestamp + ' ' + searchStartDate.getUTCHours() + ':';

         if( searchStartDate.getMinutes() < 10 )
             searchStartTimestamp = searchStartTimestamp + '0' + searchStartDate.getUTCMinutes();
         else
             searchStartTimestamp = searchStartTimestamp + searchStartDate.getUTCMinutes();

         //alert( "searchStartTimestamp=" + searchStartTimestamp);

         $('#batchIndex').val(gridData.batchIndex);

         $('#txtTimestamp').datetimepicker({
             format: 'mm/dd/yyyy HH:MM TT',
             minDate: '01/01/2018 00:00',
             value: searchStartTimestamp,
             footer: true,
             modal: true
         });
    }

    $(function() {
        var $result = $('#result');
        var refreshRate = 3000;

        function last(path) {
            var s = path.replace(/\/+$/, "").split('/');
            return s[s.length - 1];
        }

        refreshDeviceList = function(apiUrl, $deviceList) {
            $.ajax({
                url: path + apiUrl,
                method: 'GET',
                contentType: 'application/json',
                dataType: 'json',
                success: function (devices) {

                    //<a id="myLink" title="Click to do something" href = "#" onclick= "MyFunction();return false;" > link text</a >
                    var reportPathForReport01 = '/' + '@ViewData["TargetSite"]' + '/run/report/VibrationReport01/parm/';

                    $deviceList.html('');

                    $deviceList.append(
                        '<h4>Last Posted Events By Device</h4>' +
                        '<hr>'
                    );

                    for (var i = 0; i < devices.length; ++i) {
                        var device = devices[i];

						$deviceList.append(
                            '<li><p>&nbsp;</p></li><li>' +
                            '<div class="deviceInfo">' +
                            '<h3>' + device.deviceId + '</h3>' + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="runReport" href="#" onclick="popitup(' + "'" + reportPathForReport01 + device.deviceId + "','" + reportPathForReport01 + device.deviceId + "');return false;" + '">View Report</a>' +
              							'&nbsp;&nbsp;<label>Measurement Type:' + device.events[0].measurementType + '</label>' +
              							'&nbsp;&nbsp;<label>Temperature:' + device.events[0].temperature +  '</label>' +
              							'&nbsp;&nbsp;<label>Battery Level:' + device.events[0].batteryLevel +  '</label>' +
              							'&nbsp;&nbsp;<label>Timestamp:' + device.events[0].timestamp +  '</label>' +
              							'&nbsp;&nbsp;<label>Data Points Count:' + device.events[0].dataPointsCount +  '</label>' +
              							'<ul class="deviceData">'
                        );

                        for (var index = 0; index < device.events.length; index++ ) {
                            var evt = device.events[index];

                            $deviceList.append(
								'<div class="deviceInfo"><legend><label>Sensor Index:&nbsp;' + evt.sensorIndex + '</label></legend>' +
                                '<li><label>Magnitude:</label>&nbsp;' + evt.magnitude + '</li>' +
                                '<li><label>Frequency:</label>&nbsp;' + evt.frequency + '</li>' +
                                '</div>'
                            )
                        }
                        $deviceList.append(
                            '</ul></div>' +
                            '</li>'
                        );
                    }
                },
                error: function (error) {
                    $result.removeClass();
                    $result.addClass('errorResult');
                    $result.html('Failed to refresh info from [' + apiUrl + '] - Message[' + error.responseText + ']');
                }
            })
            .always(function() {
                setTimeout(function() {
                    $result.html('');
                    $result.removeClass();
                    refreshDeviceList(apiUrl, $deviceList);
                }, refreshRate);
            });
        }

        refreshQueueLength = function(apiUrl, $queueElement) {
            $.ajax({
                    url: path + apiUrl,
                    method: 'GET',
                    contentType: 'application/json',
                    dataType: 'json',
                    success: function (result) {
                        $queueElement.html(result);
                        },
                    error: function (error) {
                        window.location.href = error.responseText;
                    }
            })
            .always(function() {
                setTimeout(function() {
                    $result.html('');
                    $result.removeClass();
                    refreshQueueLength(apiUrl, $queueElement);
                }, refreshRate);
            });
        }

        refreshDeviceList('/deviceList', $('#deviceList'));
        refreshQueueLength('/queue/length', $('#queueLength'));

    });

    function popitup(url, windowName)
    {
        newwindow = window.open(url, windowName, 'height=1040,width=1300,location=no,menubar=no,status=no,toolbar=no,titlebar=no,left=50,top=50');
        if (window.focus) { newwindow.focus() }
        return false;
    }

    </script>
}
